dist: trusty
conditions: v1

language: node_js
addons:
  chrome: stable
 
env:
#- ASCIIDOCTOR_CORE_VERSION=v2.0.10
- ASCIIDOCTOR_CORE_VERSION=master #test seulement sur la branch master pour le moment

node_js:
- 'lts/*' #pour tout les utilisateurs
#- 'node' #dernière version a rajouter plus tard

jdk:
- oraclejdk8

install:
#- npm install
- npm ci #plus performant que npm install
- npm ci --prefix packages/core

#cache necessaire pour accélerer l'installation
cache:
  directories:
  - "$HOME/.npm"
  - "$HOME/.dts"

script:
- npm run lint
- npm run test
- npm run travis --prefix packages/core

jobs:
  include:
    - stage: release
      if: |
        repo = 'asciidoctor/asciidoctor.js' AND \
        tag IS present
      script:
      - ./scripts/package.sh
      - ./scripts/publish.sh
      deploy:
        - provider: releases
          api_key: ${GITHUB_TOKEN}
          file: packages/core/bin/asciidoctor.js.dist.*
          skip_cleanup: true
          file_glob: true
          on:
            tags: true
